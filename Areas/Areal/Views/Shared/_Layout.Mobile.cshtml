<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <meta name="viewport" content="width=device-width" />

    <link href="@Url.Content("~/Content/Site.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/MyStyle.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/kendo/2016.3.914/kendo.default.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/kendo/2016.3.914/kendo.common.min.css")" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/kendo/2016.3.914/kendo.mobile.all.min.css")" rel="stylesheet" type="text/css" />

    <link href="@Url.Content("~/Content/kendo/2016.3.914/kendo.dataviz.min.css")" rel="stylesheet" type="text/css" />
    @*	<link href="@Url.Content("~/Content/kendo/2016.2.714/kendo.default.min.css")" rel="stylesheet" type="text/css" />*@
    <link href="@Url.Content("~/Content/kendo/2016.3.914/kendo.dataviz.default.min.css")" rel="stylesheet" type="text/css" />

    <script src="@Url.Content("~/Scripts/kendo/2016.3.914/jquery.min.js")"></script>
    <script src="@Url.Content("~/Scripts/kendo/2016.3.914/angular.min.js")"></script>
    <script src="@Url.Content("~/Scripts/kendo/2016.3.914/jszip.min.js")"></script>
    <script src="@Url.Content("~/Scripts/kendo/2016.3.914/kendo.all.min.js")"></script>
    <script src="@Url.Content("~/Scripts/kendo/2016.3.914/kendo.aspnetmvc.min.js")"></script>
    <script src="@Url.Content("~/Scripts/cultures/kendo.culture.id-ID.min.js")"></script>
    <script src="@Url.Content("~/Scripts/cultures/kendo.culture.id.min.js")"></script>

    <script src="@Url.Content("~/Scripts/kendo.modernizr.custom.js")"></script>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    @*<script src="@Url.Content("~/Scripts/jquery-2.2.3.min.js")"></script>*@
    <!--Reference the SignalR library. -->
    <script src="@Url.Content("~/Scripts/jquery.signalR-2.2.1.min.js")"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="@Url.Content("~/signalr/hubs")"></script>
    <!--Add script to update the page and send messages.-->
</head>
<body>
    <header>
        <div class="content-wrapper">
            <table width="100%" style="margin: 0;">
                <tr>
                    <td width="50%">
                        <img src="@Url.Content("~/Content/Images/WalagriJatiUtama.jpg")" width="100%" />
                    </td>
                    <td style="text-align: right;">
                        @Html.Partial("_LogInPartial")
                    </td>
                </tr>
            </table>

            @{
                List<Ptpn8.Models.Menu> menuList = ViewBag.Menu;
            }
            @if (menuList != null)
            {
                <ul id="kmenu" style="display: none;">
                    @foreach (var mp in menuList.Where(p => p.ParentId == Guid.Empty))
                    {
                        if (@mp.InRole == "" ? true : @mp.InRole == "Authorize" ? User.Identity.IsAuthenticated : User.IsInRole(@mp.InRole))
                        {
                            <li>
                                @if (@mp.ActionName != "")
                                {
                                    if (@mp.NamaView == "")
                                    {
                                        @Html.ActionLink(@mp.LinkText, @mp.ActionName, @mp.ControllerName, new { Area = @mp.Area }, null)
                                    }
                                    else
                                    {
                                        if (@mp.ControllerName == "Home")
                                        {
                                            @Html.ActionLink(@mp.LinkText, @mp.ActionName, @mp.ControllerName, new { Area = "", aplikasi = @mp.NamaView }, null)
                                        }
                                        else
                                        {
                                            @Html.ActionLink(@mp.LinkText, @mp.ActionName, @mp.ControllerName, new { Area = "", aplikasiId = @mp.AplikasiId, menuId = @mp.MenuId }, null)
                                        }
                                    }
                                }
                                else
                                {
                                    @mp.LinkText
                                }

                                @if (menuList.Count(p => p.ParentId == mp.MenuId) > 0)
                                {
                                    @:<ul>
                                            }
                                @RenderMenuItem(menuList, mp)

                                @if (menuList.Count(p => p.ParentId == mp.MenuId) > 0)
                                {
                                    @:</ul>
                                }
                            </li>
                        }
                    }
                </ul>
            }

            @helper RenderMenuItem(List<Ptpn8.Models.Menu> menuList, Ptpn8.Models.Menu mi)
            {
foreach (var cp in menuList.Where(p => p.ParentId == mi.MenuId))
{
        @:<li>
                    if (@cp.ActionName != "")
    {
        if (@cp.InRole == "" ? true : @cp.InRole == "Authorize" ? User.Identity.IsAuthenticated : User.IsInRole(@cp.InRole))
        {
            if (@cp.NamaView == "")
            {
                    @Html.ActionLink(@cp.LinkText, @cp.ActionName, @cp.ControllerName, new { Area = @cp.Area }, null)
                }
                else
                {
                    if (@cp.ControllerName == "Home")
                    {
                        @Html.ActionLink(@cp.LinkText, @cp.ActionName, @cp.ControllerName, new { Area = "", aplikasi = @cp.NamaView }, null)
                    }
                    else
                    {
                        @Html.ActionLink(@cp.LinkText, @cp.ActionName, @cp.ControllerName, new { Area = "", aplikasiId = @cp.AplikasiId, menuId = @cp.MenuId }, null)
                    }
                }
            }
        }
        else
        {
            @cp.LinkText
    }

    if (menuList.Count(p => p.ParentId.ToString() == cp.MenuId.ToString()) > 0)
    {
            @:<ul>
                    }
        @RenderMenuItem(menuList, cp)
    if (menuList.Count(p => p.ParentId == cp.MenuId) > 0)
    {
            @:</ul>
                    }
    else
    {
            @:</li>
                    }
}
}
        </div>
    </header>
    <div id="body">
        @RenderSection("featured", required: false)
        <section class="content-wrapper main-content clear-fix">
            @RenderBody()
        </section>
    </div>

    <footer>
        <div id="chat">
            @if (User.Identity.IsAuthenticated)
            {
                @(Html.Kendo().Window()
                        .Name("windowChat")
                        .Title("Broadcast Message")
                        .Actions(actions => actions.Minimize().Maximize())
                        .Content(@<text>
                            <div class="container">
                                <table width="100%">
                                    <tr>
                                        <td width="90%">
                                            @Html.Kendo().TextBox().Name("broadcastMessage").HtmlAttributes(new { style = "width:100%" })
                                        </td>
                                        <td>
                                            @Html.Kendo().Button().Name("btnsendmessage").Content("Send")
                                        </td>
                                    </tr>
                                </table>
                                <label id="welcome"></label>
                                @(Html.Kendo().Grid<Ptpn8.Models.Chat>()
                                    .Name("grdChat")
                                    .Columns(g =>
                                    {
                                        g.Bound(i => i.ChatId).Hidden();
                                        g.Bound(i => i.Tanggal).Width(60).ClientTemplate(
                                               @"<div class='photo'><img id='#:UserId#' style='width:100%' src='" + Url.Content("~/Content/Images/View/") + "#:UserId#.jpg' alt='#: UserId #' />");
                                        g.Bound(i => i.Tanggal).Width(50).Format("{0:hh:mm}");
                                        //g.Bound(i => i.UserName).Width(150);
                                        g.Bound(i => i.TextMessage);//.Width(400);
                                    })
                                    .AutoBind(true)
                                    .Scrollable()
                                    .HtmlAttributes(new { style = "Height: 200px" })
                                    .DataSource(o => o
                                        .Ajax()
                                        .ServerOperation(false)
                                        .Sort(a => a.Add(m => m.Tanggal).Descending())
                                        .Model(model =>
                                        {
                                            model.Id(p => p.ChatId);
                                        })
                                        .Read(read => read.Action("Read", "Chat").Data("filterRead").Type(HttpVerbs.Post))
                                    )
                                )
                            </div>
                        </text>)
                    .Scrollable(true)
                    .Draggable()
                    .Resizable()
                    .Width(700)
                    .Height(250)
                )
            }
        </div>
        @Html.Partial("_ViewSwitcher")
        <div class="content-wrapper">
            <div class="float-left">
                <p>&copy; @DateTime.Now.Year - PT Perkebunan Nusantara VIII</p>
            </div>
        </div>
    </footer>
</body>
</html>

<script type="text/javascript">
    var chatRoom = "broadcastRoom"

    kendo.culture("id-ID");
    $(document).ready(function () {
        $(document).ready(function () {
            //$.mobile.ajaxEnabled = false;
        });

        $('#kmenu').css("display", "block");
        $('#kmenu').kendoPanelBar({
            //openOnClick: true
        });
        $('#kmenu').addClass("xk-menu");
        $('#windowChat').parent().find('.k-window-titlebar,.k-window-actions').css('backgroundColor', 'green');
        $('#windowChat').parent().find('.k-window-titlebar,.k-window-actions').css('color', 'white');
        $("#windowChat").data("kendoWindow").open().pin();
        $("#grdChat .k-grid-header").hide();

    });

    $(function () {
        // Declare a proxy to reference the hub.
        var chat = $.connection.chatHub;
        // Create a function that the hub can call to broadcast messages.
        chat.client.broadcastMessage = function (data) {
            // Html encode display name and message.
            var grid = $('#grdChat').data('kendoGrid');
            grid.dataSource.data(data);
            var aSound = document.createElement('audio');
            aSound.setAttribute('src', '/Sounds/Notify.wav');
            aSound.play();
        };
        chat.client.hubReceived = function (data) {
            $('#welcome').text(data);
        };

        $('#broadcastMessage').focus();

        // Start the connection.
        $.connection.hub.start().done(function () {
            $('#btnsendmessage').click(function () {
                // Call the Send method on the hub.
                chat.server.broadcast(chatRoom, $('#broadcastMessage').val());
                // Clear text box and reset focus for next comment.
                $('#broadcastMessage').val('').focus();
            });
        });
    });

    function filterRead() {
        return { roomName: chatRoom }
    }

</script>

<style type="text/css">
    .xk-menu {
        border: 0;
        color: white;
        background-color: transparent;
        font-size: small;
        font-weight: 500;
        text-decoration: none;
    }
</style>