<!--Script references. -->
<!--Reference the jQuery library. -->
@*<script src="@Url.Content("~/Scripts/jquery-2.2.3.min.js")"></script>*@
<!--Reference the SignalR library. -->
<script src="@Url.Content("~/Scripts/jquery.signalR-2.2.1.min.js")"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="@Url.Content("~/signalr/hubs")"></script>
<!--Add script to update the page and send messages.-->

<div class="pane-content">
    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                @if (System.DateTime.Today.Day <= 10 && System.DateTime.Today.Month == 9 && System.DateTime.Today.Year == 2018)
                {
                    @(
                    Html.Kendo().TextBox().Name("PengurangHari")
                        .HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" })
                        .Value(System.DateTime.Today.Day.ToString())
                    )
                }
                else
                {
                    @(
                    Html.Kendo().TextBox().Name("PengurangHari")
                        .HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" })
                        .Value("60")
                    )
                }

                @(Html.Kendo().TextBox().Name("KebunId").HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" }))
                @(Html.Kendo().TextBox().Name("UserName").Value(HttpContext.Current.User.Identity.Name).HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" }))
                @(Html.Kendo().TextBox().Name("TanggalAwal").Value(HttpContext.Current.User.Identity.Name).HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" }))
                @(Html.Kendo().TextBox().Name("TanggalAkhir").Value(HttpContext.Current.User.Identity.Name).HtmlAttributes(new { @readonly = "true", style = "width: 100%; display: none" }))

                <label style="background-color:gray; color: white; border-radius: 3px;"><span style="margin-left: 5px;">Key Code Upload Ulang</span></label>
            </td>
        </tr>
        <tr>
            <td>
                <div style="margin: 5px 5px 10px 5px ">
                    @(
                        Html.Kendo().MaskedTextBox()
                            .Name("txtKeyCode")
                            .Mask("CCCCCCCC-CCCC-CCCC-CCCC-CCCCCCCCCCCC")
                            .Events(ev=>ev.Change("txtKeyCodeOnChange"))
                            .HtmlAttributes(new { style = "width: 100%" })
                    )
                </div>
                
            </td>
        </tr>
        <tr>
            <td>
                <label style="background-color:gray; color: white; border-radius: 3px;"><span style="margin-left: 5px;">Kebun/Unit</span></label>
            </td>
        </tr>
        <tr>
            <td>
                <div style="margin: 5px 5px 10px 5px ">
                    @(Html.Kendo().DropDownList()
                                .Name("ddlKebun")
                                .AutoBind(true)
                                .OptionLabel("Pilih Kebun...")
                                .DataTextField("Nama")
                                .DataValueField("KebunId")
                                .HtmlAttributes(new { style = "width:100%" })
                                .DataSource(dataSource =>
                                {
                                    dataSource.Read(read => read.Action("GetKebun", "ddl", new { Area = "Referensi" })).ServerFiltering(true);
                                })
                                .Events(e => { e.Select("ddlKebunOnSelect"); })
                    )
                    </d
            </td>
        </tr>
        <tr>
            <td>
                <label style="background-color:gray; color: white; border-radius: 3px;"><span style="margin-left: 5px;">Bulan dan Tahun Buku</span></label>
            </td>
        </tr>
        <tr>
            <td>
                <div style="margin: 5px 5px 10px 5px ">
                    @(Html.Kendo().DropDownList()
                    .AutoBind(true)
                    .Name("nBulan")
                    .DataTextField("Text")
                    .DataValueField("Value")
                    .HtmlAttributes(new { style = "width:55%"})
                    .Events(ev=>ev.Change("BulanTahunOnChange"))
                    .Value(DateTime.Now.Month.ToString())
                    .BindTo(new List<SelectListItem>()
                    {
                        new SelectListItem() {
                            Text = "Januari",
                            Value = "1"
                        },
                        new SelectListItem() {
                            Text = "Februari",
                            Value = "2"
                        },
                        new SelectListItem() {
                            Text = "Maret",
                            Value = "3"
                        },
                        new SelectListItem() {
                            Text = "April",
                            Value = "4"
                        },
                        new SelectListItem() {
                            Text = "Mei",
                            Value = "5"
                        },
                        new SelectListItem() {
                            Text = "Juni",
                            Value = "6"
                        },
                        new SelectListItem() {
                            Text = "Juli",
                            Value = "7"
                        },
                        new SelectListItem() {
                            Text = "Agustus",
                            Value = "8"
                        },
                        new SelectListItem() {
                            Text = "September",
                            Value = "9"
                        },
                        new SelectListItem() {
                            Text = "Oktober",
                            Value = "10"
                        },
                        new SelectListItem() {
                            Text = "Nopember",
                            Value = "11"
                        },
                        new SelectListItem() {
                            Text = "Desember",
                            Value = "12"
                        }
                        })
                    )
                    -
                    @(Html.Kendo().NumericTextBox().Name("nTahun")
                        .Min(2017).Value(DateTime.Now.Year).Format("{0:0000}")
                        .Events(e=> { e.Spin("BulanTahunOnChange");e.Change("BulanTahunOnChange"); })
                        .HtmlAttributes(new { style = "width:70px" })
                        )
                </div>
            </td>
        </tr>

        <tr>
            <td>
                <label style="background-color:gray; color: white; border-radius: 3px;"><span style="margin-left: 5px;">Tanggal Data</span></label>
            </td>
        </tr>
        <tr>
            <td>
                <div id="PilihTanggal" style="margin: 5px 5px 10px 5px ">
                    @(Html.Kendo().DatePicker().Name("dtpTanggalTransaksi").Format("dd/MM/yyyy")
                        .HtmlAttributes(new { style = "width: 100%" })
                        //.DisableDates("disableDates")
                    )
                </div>
            </td>
        </tr>
    </table>

    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                <div>
                    @(Html.Kendo().Upload()
                            .Name("files")
                            .Async(a => a
                                .Save("SaveZIP", "UploadDataHarian")
                                .Remove("RemoveZIP", "UploadDataHarian")
                                .AutoUpload(true)
                            )
                            .Multiple(false)
                            .HtmlAttributes(new { style = "width: 95%;" })
                            .Events(e => { e.Success("UploadSuccess"); e.Upload("OnUpload"); })
                            .Validation(v => v.AllowedExtensions(new string[] { ".zip" }))
                            .Enable(false)
                    )
                    @(Html.Kendo().ProgressBar()
                          .Name("unzipping")
                          .Type(ProgressBarType.Percent)
                          .HtmlAttributes(new { style = "width: 99.5%;" })
                          .Animation(a => a.Duration(0))
                    )
                    <br />
                </div>
            </td>
        </tr>
    </table>

    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                <div style="margin: 5px 5px 10px 5px ">
                    <input type="button" id="btnUpload" class="k-button" value="Upload" style="width: 100%;" onclick="btnUploadOnClick()" />
                </div>
            </td>
        </tr>
    </table>
</div>

<div class="k-content" style="margin: 5px 15px">
    <label id="welcomeMsg"></label>
    <table width="100%">
        <tr>
            <td>
                <h2>Hasil Upload</h2>
                <h4>1. Data Transaksi Kehadiran dan Hasil Kerja</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajiabsensi")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>2. Data Transaksi Kulir</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajikulir")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>3. Data Transaksi Premi</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajipremi")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>4. Data Transaksi Premi Panen</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajipremipanen")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>5. Data Transaksi SPK</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajispkhonor")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>6. Data Transaksi TUP</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("tup")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>7. Data Transaksi Kas/Bank</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("kasbank")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>8. Data Transaksi Akun</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("akunmemorial")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>9. Data Transaksi Aset</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("aktivatransaksi")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>10. Data Produksi (AKUN)</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("akunproduksihp")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>11. Data Transaksi EAP/ETL</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("eap")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>12. Data RKAP/PKB</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("akunrkap")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>13. Data Produksi</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("produksi")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>14. Master Gaji</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajimaster")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>15. Ref DIK</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("ref_dik")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

        <tr>
            <td>
                <h4>16. Ref KLM</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("ref_dikklm")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>17. Penerimaan TBS</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("timbangan")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
        <tr>
            <td>
                <h4>18. Gaji PJTK</h4>
                @(Html.Kendo().ProgressBar()
                              .Name("gajipjtk")
                              .Type(ProgressBarType.Percent)
                              .HtmlAttributes(new { style = "width: 98%;" })
                              .Animation(a => a.Duration(0))
                )
            </td>
        </tr>

    </table>

    
</div>



<div id="winHasilUpload">
    <label style="text-align: center" id="SuksesKah"></label>
    <label style="text-align: center" id="Keterangan"></label>
    <button style="text-align: center" id="ok" class="delete k-button">Ok</button>
</div>

<script>
    var kodeKebun, tanggal, namaFileZIP;
    var wnd;

    $(document).ready(function () {
        wnd = $("#winHasilUpload").kendoWindow({
            title: "Konfirmasi",
            modal: true,
            visible: false,
            resizable: false,
            width: 300
        }).data("kendoWindow");
        $("#btnUpload").addClass('disabledbutton');
    });

    $(function () {
        var progress = $.connection.progressHub;

        progress.client.addProgress = function (message, percentage) {
            $("#" + message).data("kendoProgressBar").value(percentage);
        };

        $.connection.hub.start().done(function () {
            //getting the connection ID in case you want to display progress to the specific user
            //that started the process in the first place.
            var connectionId = $.connection.hub.id;
        });

    });

    function btnUploadOnClick()
    {
        tanggal = $('#dtpTanggalTransaksi').val();
        event.preventDefault();
        $("#aktivatransaksi").data("kendoProgressBar").value(0);
        $("#akunmemorial").data("kendoProgressBar").value(0);
        $("#akunproduksihp").data("kendoProgressBar").value(0);
        $("#eap").data("kendoProgressBar").value(0);
        $("#gajiabsensi").data("kendoProgressBar").value(0);
        $("#gajikulir").data("kendoProgressBar").value(0);
        $("#gajipremi").data("kendoProgressBar").value(0);
        $("#gajipremipanen").data("kendoProgressBar").value(0);
        $("#gajispkhonor").data("kendoProgressBar").value(0);
        $("#kasbank").data("kendoProgressBar").value(0);
        $("#tup").data("kendoProgressBar").value(0);
        $("#akunrkap").data("kendoProgressBar").value(0);
        $("#gajimaster").data("kendoProgressBar").value(0);
        $("#ref_dik").data("kendoProgressBar").value(0);
        $("#ref_dikklm").data("kendoProgressBar").value(0);
        $("#timbangan").data("kendoProgressBar").value(0);

        prosesZIP().done(function (data) {
            $('#SuksesKah').text(data[0]);
            $('#Keterangan').text(data[1]);
            wnd.open().center();
            $('#ok').click(function () {
                wnd.close();
            });
        }).fail(function(data){
            $('#SuksesKah').text(data[0]);
            $('#Keterangan').text(data[1]);
            wnd.open().center();
            $('#ok').click(function () {
                wnd.close();
            });
        });
    }

    function extractZIP()
    {
        var url = '/UploadDataHarian/ExtractZIP';
        return $.ajax({
            url: url,
            data: {
                _menuId: menuId,
                _kebunId: $('#KebunId').val()
            },
            type: 'POST',
            datatype: 'json'
        });
    }

    function prosesZIP() {
        var url = '/UploadDataHarian/ProsesZIP';
        return $.ajax({
            url: url,
            data: {
                _tanggal: tanggal,
                _menuId: menuId,
                _kebunId: $('#KebunId').val()
            },
            type: 'POST',
            datatype: 'json'
        });
    }

    function UploadSuccess(e) {
        extractZIP().done(function () {
            $("#btnUpload").removeClass('disabledbutton');
        });
    }

    function OnUpload(e) {
        e.data = { _kebunId : $('#KebunId').val()} ;
    }

    function ddlKebunOnSelect(e) {
        var ddlItem = this.dataItem(e.item);
        //var grid = $('#grdDetail').data('kendoGrid');
        //var dataItem = typeof (grid.dataSource.get(merkId)) == "undefined" ? grid.dataSource.getByUid(merkId) : grid.dataSource.get(merkId);
        //var row = grid.tbody.find("tr[data-uid='" + dataItem.uid + "']");
        //var data = grid.dataItem(row);
        //data.set("Kebun", ddlItem);
        $('#KebunId').val(ddlItem.KebunId);
    }
</script>

