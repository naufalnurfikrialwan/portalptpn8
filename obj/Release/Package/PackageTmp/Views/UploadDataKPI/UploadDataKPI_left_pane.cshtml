<!--Script references. -->
<!--Reference the jQuery library. -->
@*<script src="@Url.Content("~/Scripts/jquery-2.2.3.min.js")"></script>*@
<!--Reference the SignalR library. -->
<script src="@Url.Content("~/Scripts/jquery.signalR-2.2.1.min.js")"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="@Url.Content("~/signalr/hubs")"></script>
<!--Add script to update the page and send messages.-->

<div class="pane-content">
    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                <div>
                    <label style="background-color:gray; color: white; border-radius: 3px;"><span style="margin-left: 5px;">Tanggal Transaksi</span></label>
                </div>
                <div style="margin: 5px 5px 10px 5px ">
                    @(Html.Kendo().DateTimePicker().Name("dtpTanggalTransaksi").Format("MM/yyyy")
                        .Value(DateTime.Now)
                        .HtmlAttributes(new { style = "width: 100%" })
                    )
                </div>
            </td>
        </tr>
    </table>

    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                <div>
                    @(Html.Kendo().Upload()
                            .Name("files")
                            .Async(a => a
                                .Save("SaveKPI", "UploadDataKPI")
                                .Remove("RemoveKPI", "UploadDataKPI")
                                .AutoUpload(true)
                            )
                            .Multiple(false)
                            .HtmlAttributes(new { style = "width: 95%;" })
                            .Events(e => { e.Success("UploadSuccess"); })
                            .Validation(v => v.AllowedExtensions(new string[] { ".xlsx" }))
                    )
                    <br />
                </div>
            </td>
        </tr>
    </table>

    <table width="100%" style="background-color: cornflowerblue; color: white; margin-top: 5px; border-radius: 5px;">
        <tr>
            <td>
                <div style="margin: 5px 5px 10px 5px ">
                    <input type="button" id="btnUpload" class="k-button" value="Upload" style="width: 100%;" onclick="btnUploadOnClick()" />
                </div>
            </td>
        </tr>
    </table>
</div>

<div class="k-content" style="margin: 5px 15px">
    <label id="welcomeMsg"></label>
    <table width="100%">
        <tr>
            <td>
                <h2>Hasil Upload</h2>
                <h4>1. Progress Upload Data Header KPI</h4>
                @(Html.Kendo().ProgressBar()
                      .Name("headerDataKPI")
                      .Type(ProgressBarType.Percent)
                      .HtmlAttributes(new { style = "width: 98%;" })
                      .Animation(a => a.Duration(0))
                )
                <h4>2. Progress Upload Data Detail KPI</h4>
                @(Html.Kendo().ProgressBar()
                      .Name("detailDataKPI")
                      .Type(ProgressBarType.Percent)
                      .HtmlAttributes(new { style = "width: 98%;" })
                      .Animation(a => a.Duration(0))
                )
            </td>
        </tr>
    </table>
</div>



<div id="winHasilUpload">
    <label style="text-align: center" id="SuksesKah"></label>
    <label style="text-align: center" id="Keterangan"></label>
    <button style="text-align: center" id="ok" class="delete k-button">Ok</button>
</div>

<script>
    var tanggal;
    var wnd;

    $(document).ready(function () {
        wnd = $("#winHasilUpload").kendoWindow({
            title: "Konfirmasi",
            modal: true,
            visible: false,
            resizable: false,
            width: 300
        }).data("kendoWindow");
        $("#btnUpload").addClass('disabledbutton');
    });

    $(function () {
        var progress = $.connection.progressHub;

        progress.client.addProgress = function (message, percentage) {
            $("#" + message).data("kendoProgressBar").value(percentage);
        };

        $.connection.hub.start().done(function () {
            //getting the connection ID in case you want to display progress to the specific user
            //that started the process in the first place.
            var connectionId = $.connection.hub.id;
        });

    });

    function btnUploadOnClick()
    {
        tanggal = $('#dtpTanggalTransaksi').val();
        event.preventDefault();
        $("#headerDataKPI").data("kendoProgressBar").value(0);
        $("#detailDataKPI").data("kendoProgressBar").value(0);

        prosesExcel().done(function(data){
            $('#SuksesKah').text(data[0]);
            $('#Keterangan').text(data[1]);
            wnd.open().center();
            $('#ok').click(function () {
                wnd.close();
            });
        }).fail(function(data){
            $('#SuksesKah').text(data[0]);
            $('#Keterangan').text(data[1]);
            wnd.open().center();
            $('#ok').click(function () {
                wnd.close();
            });
        });
    }

    function prosesExcel() {
        var url = '/UploadDataKPI/ProsesExcel';
        return $.ajax({
            url: url,
            data: {
                _tanggal: tanggal,
                _menuId: menuId
            },
            type: 'POST',
            datatype: 'json'
        });
    }

    function UploadSuccess(e) {
        $("#btnUpload").removeClass('disabledbutton');
    }
</script>

